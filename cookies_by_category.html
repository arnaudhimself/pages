<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cookies by Category Dashboard</title>
    
    <!-- Google Fonts - Roboto --><link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap 5 CSS --><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome for Icons --><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #F8F9FA; /* Fond très clair */
            --text-color: #334155;
            /* MISE À JOUR OMBRAGE : Plus subtil, comme une ombre portée */
            --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.05), 0 1px 2px rgba(0, 0, 0, 0.03); 
            
            /* Couleurs des catégories */
            --color-essential: #002CBD; 
            --color-essential-dark: #00229a; 
            --color-analytics: #FFAE01; 
            --color-marketing: #F31DAC; 
            --color-others: #3198FD;    
            
            --color-success: #22c55e;
            --color-danger: #ef4444;

            /* Couleurs pour l'histogramme */
            --color-bar-before: #EB536C; /* Rouge modéré */
            --color-bar-after: #74D9E8;

            /* COULEUR D'ACCENTUATION */
            --color-accent: #f40754; 
        }

        body {
            background-color: var(--bg-color);
            /* Utilisation de Roboto */
            font-family: 'Roboto', sans-serif;
            color: var(--text-color);
        }

        /* Navigation Tabs Simulation */
        .main-nav {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 0 20px;
        }
        .nav-link {
            color: #64748b;
            font-weight: 500;
            padding: 15px 20px;
            border-radius: 0;
        }
        .nav-link.active {
            /* Mise à jour de la couleur du lien actif */
            color: var(--color-accent);
            border-bottom: 2px solid var(--color-accent);
        }

        /* KPI Cards */
        .kpi-card {
            background: white;
            /* MISE À JOUR ARRONDI */
            border-radius: 8px; 
            border: none;
            box-shadow: var(--card-shadow);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* Indicateur actif (barre bleue en bas) */
        .kpi-card.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
            /* Mise à jour de la couleur de surlignage */
            background-color: var(--color-accent);
        }

        .dot {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .trend-badge {
            font-size: 0.9rem;
            font-weight: 600;
        }
        .text-success-custom { color: var(--color-success); }
        .text-danger-custom { color: var(--color-danger); }

        /* Charts & Containers */
        .dashboard-card {
            background: white;
            /* MISE À JOUR ARRONDI */
            border-radius: 8px; 
            border: none;
            box-shadow: var(--card-shadow);
            height: 100%;
            padding: 20px;
        }

        /* Table Styles */
        .custom-table th {
            font-weight: 600;
            color: #1e293b;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 15px;
        }
        .custom-table td {
            vertical-align: middle;
            padding: 15px 10px;
            color: #475569;
        }
        .table-row-active {
            /* Mise à jour de la couleur du fond du surlignage (couleur plus claire) */
            background-color: #fde8ed !important; 
            /* Mise à jour de la couleur de la bordure */
            border-left: 4px solid var(--color-accent);
        }

        /* Styles pour les lignes de détails (cookies) */
        .detail-row {
            background-color: #f8fafc;
        }
        .cookie-badge {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.35em 0.65em;
        }
        .bg-before {
            background-color: var(--color-bar-before);
            color: white;
        }
        .bg-after {
            background-color: var(--color-bar-after);
            color: #334155;
        }
        .chevron-icon {
            transition: transform 0.2s ease;
        }
        .chevron-rotated {
            transform: rotate(180deg);
        }

        /* Top Controls */
        .control-bar {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .form-select-sm-custom {
            border-radius: 6px;
            border: 1px solid #cbd5e1;
            padding: 5px 30px 5px 10px;
        }
    </style>
</head>
<body>

<div id="app">

    <div class="container-fluid px-4 pb-5">
        
        <!-- Header Section --><div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="h3 fw-bold text-dark m-0">Cookies by Category</h2>
            
            <div class="control-bar">
                <span class="text-secondary small fw-bold">Last 7 days</span>
                
                <!-- Domain Dropdown --><div class="bg-white p-1 rounded border">
                    <select class="form-select form-select-sm border-0 fw-bold" v-model="selectedDomain">
                        <option>Domain</option>
                        <option>example.com</option>
                        <option>shop.example.com</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Top KPI Cards Row --><div class="row g-4 mb-4">
            <div class="col-md-3" v-for="(cat, index) in categories" :key="cat.name">
                <kpi-card
                    :category="cat"
                    :is-active="selectedCategory === cat.name"
                    @select="selectCategory(cat.name)"
                ></kpi-card>
            </div>
        </div>

        <!-- Charts Row --><div class="row g-4 mb-4">
            <!-- Donut Chart --><div class="col-md-5">
                <div class="dashboard-card d-flex flex-column align-items-center justify-content-center">
                    <h5 class="fw-bold mb-4 w-100 text-center">Category share</h5>
                    <div style="height: 250px; width: 250px; position: relative;">
                        <!-- Utilisation du nouveau composant pour le Donut Chart --><chart-wrapper
                            chart-id="donutChart"
                            type="doughnut"
                            :chart-data="donutChartData"
                            :chart-options="donutChartOptions"
                        ></chart-wrapper>
                    </div>
                    <!-- Custom Legend --><div class="d-flex justify-content-center gap-3 mt-4 flex-wrap">
                        <div v-for="cat in categories" :key="cat.name" class="d-flex align-items-center small">
                            <span class="dot" :style="{ backgroundColor: cat.color }"></span>
                            <span class="fw-bold text-secondary">{{ cat.name }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bar Chart --><div class="col-md-7">
                <div class="dashboard-card">
                    <h5 class="fw-bold mb-4 text-center">Before consent vs After consent by category</h5>
                    <div style="height: 300px;">
                        <!-- Utilisation du nouveau composant pour le Bar Chart --><chart-wrapper
                            chart-id="barChart"
                            type="bar"
                            :chart-data="barChartData"
                            :chart-options="barChartOptions"
                        ></chart-wrapper>
                    </div>
                    <div class="d-flex justify-content-center gap-4 mt-2 small">
                        <div class="d-flex align-items-center"><span class="dot" :style="{ backgroundColor: 'var(--color-bar-before)' }"></span> Before</div>
                        <div class="d-flex align-items-center"><span class="dot" :style="{ backgroundColor: 'var(--color-bar-after)' }"></span> After</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detail Table --><data-table
            :categories="categories"
            :selected-category="selectedCategory"
            @select-category="selectCategory"
        ></data-table>

    </div>
</div>

<!-- Scripts --><!-- Vue 3 --><script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<!-- Chart.js --><script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const { createApp, ref, onMounted, watch, computed, nextTick } = Vue;

    // Définir la police pour Chart.js globalement
    Chart.defaults.font.family = 'Roboto, sans-serif';

    // --- 1. KPI Card Component ---
    const KpiCard = {
        props: ['category', 'isActive'],
        template: `
            <div 
                class="kpi-card p-3 text-center" 
                :class="{ 'active': isActive }"
                @click="$emit('select')"
            >
                <div class="text-secondary mb-2 fw-bold">
                    {{ category.name }} <span class="dot ms-1" :style="{ backgroundColor: category.color }"></span>
                </div>
                <div class="d-flex justify-content-center align-items-end gap-2">
                    <h2 class="display-5 fw-bold m-0">{{ category.count }}</h2>
                    <div class="mb-2 d-flex flex-column align-items-center" 
                            :class="category.trend > 0 ? 'text-success-custom' : 'text-danger-custom'">
                        <i :class="category.trend > 0 ? 'fas fa-arrow-up' : 'fas fa-arrow-down'"></i>
                        <span class="trend-badge">{{ Math.abs(category.trend) }}%</span>
                    </div>
                </div>
            </div>
        `
    };

    // --- 2. Data Table Component (Updated for Expansion and Column Removal) ---
    const DataTable = {
        props: ['categories', 'selectedCategory'],
        emits: ['selectCategory'],
        setup(props) {
            const expandedCategories = ref([]);

            const toggleExpand = (categoryName) => {
                const index = expandedCategories.value.indexOf(categoryName);
                if (index === -1) {
                    expandedCategories.value.push(categoryName);
                } else {
                    expandedCategories.value.splice(index, 1);
                }
            };

            const isExpanded = (categoryName) => {
                return expandedCategories.value.includes(categoryName);
            };

            return { expandedCategories, toggleExpand, isExpanded };
        },
        template: `
            <div class="dashboard-card p-0 overflow-hidden">
                <div class="table-responsive">
                    <table class="table table-hover custom-table m-0">
                        <thead class="bg-white">
                            <tr>
                                <th class="ps-4" style="width: 50px;"></th> <!-- Chevron column -->
                                <th class="text-secondary" style="width: 50px;">#</th> <!-- Index column -->
                                <th>Category</th>
                                <th class="text-center">Cookies count</th>
                                <th>Pre-consent detected</th>
                                <!-- Colonnes supprimées: Pages impacted, Visible in Notice -->
                                <th class="text-center">Vendors</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template v-for="(cat, index) in categories" :key="cat.name">
                                <!-- Main Row -->
                                <tr 
                                    :class="{ 'table-row-active': selectedCategory === cat.name }"
                                    @click="toggleExpand(cat.name); $emit('selectCategory', cat.name)"
                                    style="cursor: pointer;">
                                    
                                    <td class="ps-4 text-secondary">
                                        <i class="fas fa-chevron-down chevron-icon" :class="{ 'chevron-rotated': isExpanded(cat.name) }"></i>
                                    </td>
                                    <td class="text-secondary">{{ index + 1 }}</td>
                                    <td class="fw-bold">{{ cat.name }}</td>
                                    <td class="text-center">{{ cat.count }}</td>
                                    <td>
                                        <!-- Affichage de la valeur cohérente (Yes/No) -->
                                        <span class="fw-bold">{{ cat.preConsentDetected }}</span>
                                    </td>
                                    <td class="text-center">{{ cat.vendors }}</td>
                                </tr>
                                
                                <!-- Detail Row (Cookies List) -->
                                <tr v-if="isExpanded(cat.name)" class="detail-row">
                                    <td colspan="7" class="p-0"> <!-- Colspan ajusté à 7 (total des colonnes) -->
                                        <div class="p-4">
                                            <h6 class="fw-bold mb-3 text-secondary small text-uppercase">Cookies Detected in {{ cat.name }}</h6>
                                            <div class="table-responsive">
                                                <table class="table table-sm table-borderless mb-0">
                                                    <thead class="text-secondary small">
                                                        <tr>
                                                            <th>Cookie Name</th>
                                                            <th>Domain</th>
                                                            <th>Duration</th>
                                                            <th>Detection Status</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr v-for="cookie in cat.cookiesList" :key="cookie.name">
                                                            <td class="fw-medium text-dark">{{ cookie.name }}</td>
                                                            <td class="text-muted small">{{ cookie.domain }}</td>
                                                            <td class="text-muted small">{{ cookie.duration }}</td>
                                                            <td>
                                                                <span class="badge rounded-pill cookie-badge" 
                                                                    :class="cookie.type === 'Before' ? 'bg-before' : 'bg-after'">
                                                                    {{ cookie.type }} Consent
                                                                </span>
                                                            </td>
                                                        </tr>
                                                        <tr v-if="!cat.cookiesList || cat.cookiesList.length === 0">
                                                            <td colspan="4" class="text-muted fst-italic">No specific cookies data available.</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        `
    };

    // --- 3. Chart Wrapper Component ---
    const ChartWrapper = {
        props: ['chartId', 'type', 'chartData', 'chartOptions'],
        setup(props) {
            let chartInstance = null;
            
            const renderChart = () => {
                const ctx = document.getElementById(props.chartId).getContext('2d');
                if (chartInstance) {
                    chartInstance.data = props.chartData;
                    chartInstance.options = props.chartOptions;
                    chartInstance.update();
                } else {
                    chartInstance = new Chart(ctx, {
                        type: props.type,
                        data: props.chartData,
                        options: props.chartOptions,
                    });
                }
            };
            
            watch(() => props.chartData, () => {
                nextTick(renderChart); 
            }, { deep: true });

            onMounted(() => {
                renderChart();
            });

            return {};
        },
        template: `<canvas :id="chartId"></canvas>`
    };


    const App = {
        setup() {
            // --- State ---
            const selectedCategory = ref('Essential'); 
            const selectedDomain = ref('Domain');

            // Data Model with Mock Cookies List
            const categories = ref([
                { 
                    name: 'Essential', 
                    count: 7, 
                    trend: 12, 
                    color: '#002CBD', 
                    preConsentDetected: 'Yes', /* MISE À JOUR : Yes */
                    pagesImpacted: 5,
                    vendors: 5,
                    visibleInNotice: true,
                    chartDataBefore: 7, /* Tous en BEFORE */
                    chartDataAfter: 0, /* Aucun en AFTER */
                    cookiesList: [
                        { name: 'PHPSESSID', domain: '.example.com', duration: 'Session', type: 'Before' },
                        { name: 'cc_cookie', domain: '.example.com', duration: '6 months', type: 'Before' },
                        { name: 'AWSALB', domain: 'aws.amazon.com', duration: '7 days', type: 'Before' },
                        { name: 'XSRF-TOKEN', domain: '.example.com', duration: 'Session', type: 'Before' },
                        { name: 'auth_token', domain: '.shop.example.com', duration: '1 day', type: 'Before' }
                    ]
                },
                { 
                    name: 'Analytics', 
                    count: 18, 
                    trend: -5, 
                    color: '#FFAE01', 
                    preConsentDetected: 'Yes', /* MISE À JOUR : Yes */
                    pagesImpacted: 50,
                    vendors: 4,
                    visibleInNotice: false,
                    chartDataBefore: 3,  
                    chartDataAfter: 15,
                    cookiesList: [
                        { name: '_ga', domain: '.example.com', duration: '2 years', type: 'Before' },
                        { name: '_gid', domain: '.example.com', duration: '24 hours', type: 'Before' },
                        { name: '_gat', domain: '.example.com', duration: '1 minute', type: 'Before' },
                        { name: 'ai_user', domain: '.microsoft.com', duration: '1 year', type: 'After' },
                        { name: '_hjid', domain: '.hotjar.com', duration: '1 year', type: 'After' }
                    ]
                },
                { 
                    name: 'Marketing', 
                    count: 40, 
                    trend: -18, 
                    color: '#F31DAC', 
                    preConsentDetected: 'Yes', /* MISE À JOUR : Yes */
                    pagesImpacted: 8,
                    vendors: 8,
                    chartDataBefore: 5,  
                    chartDataAfter: 35,
                    visibleInNotice: false,
                    cookiesList: [
                        { name: 'fbp', domain: '.facebook.com', duration: '3 months', type: 'Before' },
                        { name: 'fr', domain: '.facebook.com', duration: '3 months', type: 'Before' },
                        { name: 'ads_prefs', domain: '.google.com', duration: '1 year', type: 'Before' },
                        { name: 'IDE', domain: '.doubleclick.net', duration: '1 year', type: 'Before' },
                        { name: 'MUID', domain: '.bing.com', duration: '1 year', type: 'Before' },
                        { name: 'test_cookie', domain: '.doubleclick.net', duration: '15 mins', type: 'After' }
                    ]
                },
                { 
                    name: 'Others', 
                    count: 13, 
                    trend: -3, 
                    color: '#3198FD', 
                    preConsentDetected: 'Yes', /* MISE À JOUR : Yes (était 'No') */
                    pagesImpacted: 3,
                    vendors: 2,
                    chartDataBefore: 2,  
                    chartDataAfter: 11,
                    visibleInNotice: true,
                    cookiesList: [
                        { name: 'player_id', domain: '.vimeo.com', duration: '1 year', type: 'Before' },
                        { name: 'vuid', domain: '.vimeo.com', duration: '2 years', type: 'Before' },
                        { name: 'lang', domain: '.cdn.net', duration: 'Session', type: 'After' },
                        { name: 'custom_pref', domain: '.example.com', duration: '30 days', type: 'After' }
                    ]
                }
            ]);

            // --- Computed Data ---
            const donutChartData = computed(() => ({
                labels: categories.value.map(c => c.name),
                datasets: [{
                    data: categories.value.map(c => c.count), 
                    backgroundColor: categories.value.map(c => c.color), 
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            }));

            const donutChartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '55%',
                plugins: {
                    legend: { display: false }, 
                    tooltip: { enabled: true }
                }
            };

            const barChartData = computed(() => ({
                labels: categories.value.map(c => c.name),
                datasets: [
                    {
                        label: 'Before',
                        data: categories.value.map(c => c.chartDataBefore),
                        backgroundColor: '#EB536C', 
                        borderRadius: 4,
                        barPercentage: 0.6,
                        categoryPercentage: 0.8
                    },
                    {
                        label: 'After',
                        data: categories.value.map(c => c.chartDataAfter),
                        backgroundColor: '#74D9E8', 
                        borderRadius: 4,
                        barPercentage: 0.6,
                        categoryPercentage: 0.8
                    }
                ]
            }));

            const barChartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        stacked: false, 
                        max: 40, 
                        grid: {
                            color: '#f1f5f9',
                            borderDash: [5, 5]
                        },
                        border: { display: false }
                    },
                    x: {
                        stacked: false,
                        grid: { display: false },
                        border: { display: false }
                    }
                },
                plugins: {
                    legend: { display: false } 
                }
            };


            // --- Methods ---
            const selectCategory = (name) => {
                selectedCategory.value = name;
            };

            return {
                selectedCategory,
                selectedDomain,
                categories,
                selectCategory,
                donutChartData,
                donutChartOptions,
                barChartData,
                barChartOptions
            };
        }
    };

    const app = createApp(App);
    app.component('KpiCard', KpiCard);
    app.component('DataTable', DataTable);
    app.component('ChartWrapper', ChartWrapper); 
    app.mount('#app');
</script>

</body>
</html>
